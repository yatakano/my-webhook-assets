/**
 * ==============================================================================
 * ã€è¨­å®šã‚¨ãƒªã‚¢ã€‘ â˜…ã“ã“ã‚’è‡ªåˆ†ã®å†…å®¹ã«æ›¸ãæ›ãˆã¦ãã ã•ã„â˜…
 * ==============================================================================
 */
const CONFIG = {
  // 1. é€šçŸ¥å…ˆï¼ˆGoogle Chat ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯ï¼‰
  CHAT_WEBHOOK_URL: "â˜…è‡ªåˆ†ã®ã‚¦ã‚§ãƒ–ãƒ•ãƒƒã‚¯URLâ˜…",
     
  // 2. ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š
  SHEET_ID: "â˜…è‡ªåˆ†ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDâ˜…",
  SHEET_NAME: "æ‹…å½“æ¡ˆä»¶",
   
  // 3. è‡ªåˆ†å®›ã®SACCSãƒ¡ãƒ¼ãƒ«ã‚’åˆ¤åˆ¥ã™ã‚‹ãŸã‚ã®ãƒ©ãƒ™ãƒ«å
  SACCS_MY_FILTER_LABEL: "â˜…SACCS_è‡ªåˆ†ã®ã‚¤ãƒ‹ã‚·ãƒ£ãƒ«â˜…",
     
  // 4. Gmailã®æ¤œç´¢è¨­å®šï¼ˆæœªèª­ãƒ¡ãƒ¼ãƒ«ã‚’å¯¾è±¡ã«ã—ã¾ã™ï¼‰
  LABELS: {
    COUPA: 'label:coupa_all is:unread',
    SACCS: 'label:SACCS_all is:unread',
    ML:    'label:to_ML is:unread'
  }
};
 
/**
 * ==============================================================================
 * ã€ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒªã‚¢ã€‘ ã“ã“ã‹ã‚‰ä¸‹ã¯åŸå‰‡å¤‰æ›´ä¸è¦ã§ã™ï¼ˆ2026-02-05æ›´æ–°ï¼‰
 * ==============================================================================
 */
 
const INTERNAL_LABELS = {
  COUPA_DONE: "coupa_assigned"
};
 
function checkAllSystemEmails() {
  const ss = SpreadsheetApp.openById(CONFIG.SHEET_ID);
  const sheet = ss.getSheetByName(CONFIG.SHEET_NAME);
  const lastRow = sheet.getLastRow();
 
  let keywords = [];
  if (lastRow >= 2) {
    const data = sheet.getRange(2, 1, lastRow - 1, 2).getValues();
    keywords = data
      .filter(row => String(row[0]).trim() !== "")
      .map(row => String(row[0]).trim());
  }
 
  const labelCoupa =
    GmailApp.getUserLabelByName(INTERNAL_LABELS.COUPA_DONE) ||
    GmailApp.createLabel(INTERNAL_LABELS.COUPA_DONE);
 
  processEmails(CONFIG.LABELS.COUPA, keywords, labelCoupa, "Coupa");
  processEmails(CONFIG.LABELS.SACCS, [], null, "SACCS");
  processEmails(CONFIG.LABELS.ML, keywords, labelCoupa, "MLå®›æ¡ˆä»¶");
}
 
function processEmails(query, keywords, targetLabel, systemName) {
  // å–å¾—æ¼ã‚Œé˜²æ­¢ã®ãŸã‚ä¸Šé™ã‚’30ä»¶ã«è¨­å®š
  const threads = GmailApp.search(query, 0, 30);
 
  threads.forEach(thread => {
    const messages = thread.getMessages();
 
    messages.forEach(message => {
      if (!message.isUnread()) return;
 
      const subject = message.getSubject();
      const dateStr = Utilities.formatDate(message.getDate(), "JST", "yyyy/MM/dd HH:mm");
      const gmailLink = thread.getPermalink();
 
      let taskActionLink = "";
      let extractedId = "";
      let shouldNotify = false;
 
      if (systemName === "Coupa") {
        // ===== Coupa: ãƒ—ãƒ¬ãƒ¼ãƒ³æœ¬æ–‡ã«ç„¡ã„URLï¼ˆHTML/urldefenseï¼‰ã‚‚æ‹¾ã† =====
        const plain = message.getPlainBody() || "";
        const html = message.getBody() || "";
 
        const normalize = (s) => String(s)
          .replace(/=\r?\n/g, "")   // quoted-printableæŠ˜ã‚Šè¿”ã—
          .replace(/\r?\n/g, " ");  // æ”¹è¡Œæ½°ã—
 
        const haystack = normalize(plain + "\n" + html);
 
        // é€šå¸¸URL / urldefense ã®ä¸¡å¯¾å¿œï¼ˆ1è¡Œå®Œçµã§è²¼ã‚Šä»˜ã‘äº‹æ•…é˜²æ­¢ï¼‰
        const reNormal = /https?:\/\/lycorp-jp\.coupahost\.com\/quotes\/requests\/(\d+)/i;
        const reDefense = /urldefense\.com\/v3\/__https?:\/\/lycorp-jp\.coupahost\.com\/quotes\/requests\/(\d+)__;/i;
 
        const m = haystack.match(reNormal) || haystack.match(reDefense);
 
        if (m) {
          extractedId = String(m[1]).trim();
 
          // IDä¸€è‡´ï¼ˆæ•°å­—ã®ã¿ã§æ¯”è¼ƒï¼‰
          shouldNotify = keywords.some(kw => {
            const cleanKw = String(kw).replace(/[^0-9]/g, "");
            const cleanExt = extractedId.replace(/[^0-9]/g, "");
            return (cleanKw !== "" && cleanKw === cleanExt);
          });
 
          // action linkã¯å›ºå®šURLï¼ˆurldefenseå¤–å´ã¯ä½¿ã‚ãªã„ï¼‰
          taskActionLink = "https://lycorp-jp.coupahost.com/quotes/requests/" + extractedId;
        }
 
      } else if (systemName === "SACCS") {
        const body = message.getPlainBody() || "";
        const currentLabels = thread.getLabels().map(l => l.getName());
 
        if (currentLabels.includes(CONFIG.SACCS_MY_FILTER_LABEL) && !body.includes("/share/")) {
          const saccsUrlMatch = body.match(/https?:\/\/saccs\.workers-hub\.com\/inspections\/target\/list\/[^\s\n\r<>"]+/);
          if (saccsUrlMatch) {
            shouldNotify = true;
            extractedId = "SACCSå®Œäº†";
            taskActionLink = saccsUrlMatch[0];
          }
        }
 
      } else if (systemName === "MLå®›æ¡ˆä»¶") {
        const body = message.getPlainBody() || "";
 
        const hashIdMatch = subject.match(/#(\d+)/) || body.match(/#(\d+)/);
        if (hashIdMatch) {
          extractedId = String(hashIdMatch[1]).trim();
          shouldNotify = keywords.some(kw =>
            String(kw).replace(/[^0-9]/g, "") === extractedId.replace(/[^0-9]/g, "")
          );
        } else {
          shouldNotify = keywords.some(kw => subject.includes(String(kw).trim()));
        }
 
        taskActionLink = gmailLink;
      }
 
      if (shouldNotify) {
        sendToGoogleChat(systemName, subject, gmailLink, extractedId, dateStr);
        createTodoTask(systemName, subject, extractedId, taskActionLink, dateStr);
        if (targetLabel) thread.addLabel(targetLabel);
        message.markRead();
      } else {
        // ã‚ãªãŸã®ä»•æ§˜ç¶­æŒï¼šCoupa/SACCSã¯é€šçŸ¥ã—ãªã„ãªã‚‰æ—¢èª­åŒ–
        if (systemName === "Coupa" || systemName === "SACCS") {
          message.markRead();
        }
      }
    });
  });
}
 
function createTodoTask(systemName, subject, keyword, taskActionLink, dateStr) {
  try {
    Tasks.Tasks.insert({
      title: "ã€" + systemName + "ã€‘ID:" + keyword + " / " + subject,
      notes: "å—ä¿¡: " + dateStr + "\nğŸ”— ãƒªãƒ³ã‚¯: " + taskActionLink
    }, "@default");
  } catch (e) {
    console.log("ToDoå¤±æ•—: " + e.message);
  }
}
 
function sendToGoogleChat(systemName, subject, gmailLink, keyword, dateStr) {
  const icon = (systemName === "Coupa") ? "ğŸ¤‘" : (systemName === "SACCS") ? "ğŸ‘¿" : "ğŸ“§";
  const payload = {
    text:
      icon + " *ã€" + systemName + " æ‹…å½“æ¡ˆä»¶é€šçŸ¥ã€‘*\n" +
      "ğŸ”¹ *ID:* " + keyword + "\n" +
      "ğŸ”¹ *ä»¶å:* " + subject + "\n" +
      "ğŸ”¹ *å—ä¿¡:* " + dateStr + "\n" +
      "ğŸ“¥ *Gmail:* " + gmailLink
  };
 
  UrlFetchApp.fetch(CONFIG.CHAT_WEBHOOK_URL, {
    method: "post",
    contentType: "application/json",
    payload: JSON.stringify(payload)
  });
}
